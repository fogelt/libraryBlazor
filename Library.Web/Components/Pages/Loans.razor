@page "/loans"
@rendermode InteractiveServer
@using Library.Core.Models
@using Library.Core.Models.Items
@using Library.Web.Components.UI
@using Library.Web.Services
@inject LibraryService LibraryService

<PageTitle>Library Loans</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-5 mt-4">
  <h2 class="fw-light text-white m-0 uppercase" style="letter-spacing: 0.2em;">Active Loans</h2>
  <button class="btn btn-sm glass-card text-white px-4 py-2 border-white border-opacity-10 shadow-sm"
          @onclick="() => showModal = true">
    <i class="bi bi-calendar2-plus me-2"></i> New Loan
  </button>
</div>

<div class="glass-card p-4">
  @if (activeLoans == null)
  {
    <div class="text-center opacity-50 py-5">
      <div class="spinner-border text-light opacity-25" role="status"></div>
    </div>
  }
  else if (!activeLoans.Any())
  {
    <div class="text-center opacity-50 py-5">No active loans found.</div>
  }
  else
  {
    <LoanTable Loans="pagedLoans.ToList()" OnReturnItem="HandleReturn" />
  }
</div>

@if (totalPages > 1)
{
  <Pagination CurrentPage="currentPage" TotalPages="totalPages" OnPageChanged="(page) => currentPage = page" />
}

@if (showModal)
{
  <NewLoanModal Members="allMembers" Items="allItems" OnClose="() => showModal = false" OnLoanCreated="RefreshData" />
}

@code {
  private List<Loan>? activeLoans;
  private List<Member> allMembers = new();
  private List<LibraryItem> allItems = new();
  private bool showModal = false;

  // Pagination State
  private int currentPage = 1;
  private int pageSize = 4;

  private IEnumerable<Loan> pagedLoans => activeLoans?
      .Skip((currentPage - 1) * pageSize)
      .Take(pageSize) ?? Enumerable.Empty<Loan>();

  private int totalPages => activeLoans == null ? 0 : (int)Math.Ceiling((double)activeLoans.Count / pageSize);

  protected override async Task OnInitializedAsync() => await RefreshData();

  private async Task RefreshData()
  {
    allMembers = await LibraryService.GetAllMembersAsync();
    allItems = await LibraryService.GetAllItemsAsync();
    activeLoans = await LibraryService.GetAllLoansAsync();

    if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
    StateHasChanged();
  }

  private async Task HandleReturn(string loanId)
  {
    if (await LibraryService.ReturnItemAsync(loanId))
    {
      await RefreshData();
    }
  }
}