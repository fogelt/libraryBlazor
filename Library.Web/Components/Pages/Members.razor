@rendermode InteractiveServer
@page "/members"
@using Library.Core.Models
@using Library.Web.Components.UI
@using Library.Web.Services
@inject LibraryService LibraryService

<PageTitle>Library Members</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-5 mt-4">
  <h2 class="fw-light text-white m-0 uppercase" style="letter-spacing: 0.2em;">Library Members
  </h2>

  <button class="btn btn-sm glass-card text-white px-4 py-2 border-white border-opacity-10 shadow-sm"
          @onclick="() => showAddModal = true">
    <i class="bi bi-person-plus me-2"></i> Add Member
  </button>
</div>

@if (allMembers == null)
{
  <div class="text-center py-5">
    <div class="spinner-border text-light opacity-25" role="status"></div>
  </div>
}
<div class="row glass-card">
  @foreach (Member member in pagedMembers)
  {
    <div @onclick="() => SelectMember(member)" class="col-md-4 position-relative cursor-pointer">
      <MemberCard Member="member" />
      <button
        class="btn btn-sm position-absolute top-0 end-0 m-3 hover-opacity-100 shadow-none glass-card text-danger border-white border-opacity-10"
        @onclick="() => DeleteMember(member)" @onclick:stopPropagation="true">
        <i class="bi bi-trash"></i>
      </button>
    </div>
  }
</div>

@if (totalPages > 1)
{
  <Pagination CurrentPage="currentPage" TotalPages="totalPages" OnPageChanged="HandlePageChange" />
}

@if (showAddModal)
{
  <AddMemberModal OnClose="() => showAddModal = false" OnMemberAdded="RefreshMembers" />
}

@if (selectedMember != null)
{
  <MemberDetailsModal Member="selectedMember" OnClose="() => selectedMember = null" />
}

@code {
  private List<Member>? allMembers;
  private Member? selectedMember;
  private bool showAddModal = false;

  // Pagination State
  private int currentPage = 1;
  private int pageSize = 12;

  private IEnumerable<Member> pagedMembers => allMembers?
      .Skip((currentPage - 1) * pageSize)
      .Take(pageSize) ?? Enumerable.Empty<Member>();

  private int totalPages => allMembers == null ? 0 : (int)Math.Ceiling((double)allMembers.Count / pageSize);

  protected override async Task OnInitializedAsync() => await RefreshMembers();

  private async Task RefreshMembers()
  {
    allMembers = await LibraryService.GetAllMembersAsync();
    // Reset to page 1 if current page is now out of bounds after a delete
    if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
    StateHasChanged();
  }

  private async Task DeleteMember(Member member)
  {
    await LibraryService.DeleteMemberAsync(member);
    await RefreshMembers();
  }

  private void HandlePageChange(int newPage) => currentPage = newPage;
  private void SelectMember(Member member) => selectedMember = member;
}